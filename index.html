<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SHINKANSEN AR TERMINAL - KSRG</title>
<script src="https://cdn.tailwindcss.com"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Noto+Serif+JP:wght@900&display=swap');

:root {
  --blood: #770000;
  --neon: #ff0000;
}

body {
  background: #030000;
  color: var(--neon);
  font-family: 'Share Tech Mono', 'Noto Serif JP', serif;
  overscroll-behavior: none;
  overflow-x: hidden;
}

/* CRT 走査線 */
.scanlines::after {
  content: " ";
  display: block;
  position: fixed; inset: 0;
  background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.2) 50%);
  background-size: 100% 4px;
  z-index: 1000;
  pointer-events: none;
}

.terminal-border {
  border: 1px solid var(--blood);
  background: rgba(15, 0, 0, 0.85);
  backdrop-filter: blur(4px);
}

.glitch {
  animation: glitch-anim 0.6s infinite linear alternate-reverse;
}
@keyframes glitch-anim {
  0% { transform: translate(0); text-shadow: 1px 0 blue; }
  50% { transform: translate(-2px, 1px); text-shadow: -1px 0 red; }
  100% { transform: translate(0); }
}

#scare-overlay {
  display: none;
  position: fixed; inset: 0;
  z-index: 9999;
  background: #000;
  justify-content: center; align-items: center;
}
.scare-img {
  width: 100%; height: 100%; object-fit: cover;
  filter: contrast(400%) grayscale(1);
  animation: shake 0.05s infinite;
}
@keyframes shake {
  0% { transform: translate(8px, 8px); }
  50% { transform: translate(-15px, -8px); }
  100% { transform: translate(8px, 15px); }
}

.btn-horror {
  border: 1px solid var(--neon);
  background: rgba(150, 0, 0, 0.1);
  transition: all 0.3s;
}
.btn-horror:active, .btn-horror:hover {
  background: var(--neon);
  color: black;
  box-shadow: 0 0 20px var(--neon);
}

.flash-white { animation: flashW 0.4s ease-out; }
@keyframes flashW { 0% { background: #fff; } 100% { background: transparent; } }

.hidden { display: none !important; }
</style>
</head>
<body class="min-h-screen flex flex-col p-3 md:p-6 scanlines">

<div id="scare-overlay">
  <img src="https://images.unsplash.com/photo-1509248961158-e54f6934749c?q=80&w=2000" class="scare-img" alt="scare">
</div>

<!-- Header -->
<header class="flex justify-between items-center text-[9px] md:text-[11px] mb-3 md:mb-6 border-b border-red-900 pb-2 opacity-70">
  <div class="flex items-center gap-1 md:gap-2">
    <span class="w-2 h-2 bg-red-600 rounded-full animate-ping"></span>
    <span class="hidden sm:inline">TERMINAL_</span>2026_KSRG
  </div>
  <div class="tracking-[0.2em] md:tracking-[0.5em] font-bold">東京 ≫≫ 新大阪</div>
  <div id="clock">00:00:00</div>
</header>

<main class="flex-grow flex flex-col lg:grid lg:grid-cols-12 gap-4 md:gap-6 overflow-hidden">
  
  <!-- Sidebar -->
  <aside class="order-2 lg:order-1 lg:col-span-3 flex flex-col gap-3">
    <div class="terminal-border p-3 md:p-4 flex-grow overflow-y-auto max-h-[150px] lg:max-h-full">
      <h2 class="text-[10px] md:text-[11px] mb-2 md:mb-4 text-red-500 font-bold border-b border-red-900 pb-1">運行状況 (STATUS)</h2>
      <div id="station-list" class="grid grid-cols-2 lg:grid-cols-1 gap-2 lg:gap-5 text-[9px] md:text-[10px] opacity-30">
        <div id="st-tokyo">● 東京駅</div>
        <div id="st-atami">○ 熱海</div>
        <div id="st-shizuoka">○ 静岡</div>
        <div id="st-seki">○ 関ヶ原</div>
        <div id="st-kyoto">○ 京都駅</div>
        <div id="st-osaka">○ 新大阪</div>
      </div>
    </div>
  </aside>

  <!-- Main Viewport -->
  <section class="order-1 lg:order-2 lg:col-span-6 flex flex-col relative min-h-[400px] lg:min-h-0">
    <div id="main-viewport" class="terminal-border flex-grow flex flex-col items-center justify-center p-6 md:p-10 relative overflow-hidden">
      
      <!-- UI: START -->
      <div id="ui-start" class="text-center">
        <h1 class="text-4xl md:text-7xl font-black mb-4 glitch">きさらぎ駅</h1>
        <p class="text-[9px] md:text-[10px] tracking-[0.6em] mb-10 opacity-50">SHINKANSEN AR EXPERIENCE</p>
        <button onclick="startJourney()" class="btn-horror px-10 md:px-20 py-4 md:py-5 text-xs md:text-sm font-bold">
          接続開始 (CONNECT)
        </button>
      </div>

      <!-- UI: AR PROCESSING -->
      <div id="ui-ar" class="hidden w-full text-center">
        <div id="announcement" class="text-lg md:text-2xl font-serif mb-8 md:mb-12 h-20 flex items-center justify-center leading-snug px-4">
            GPS同期中...
        </div>
        <div class="relative w-32 h-32 md:w-48 md:h-48 mx-auto">
            <div class="absolute inset-0 border-2 md:border-4 border-red-900 rounded-full animate-ping opacity-20"></div>
            <div class="absolute inset-2 md:inset-4 border border-red-600 rounded-full animate-pulse flex items-center justify-center">
                <span id="ar-status-text" class="text-[8px] md:text-[10px]">SCANNING</span>
            </div>
        </div>
      </div>

      <!-- UI: ARRIVAL (UNLOCK) -->
      <div id="ui-arrival" class="hidden text-center">
        <h2 class="text-3xl md:text-4xl font-bold mb-4 glitch text-white">目的地到着</h2>
        <p class="text-xs md:text-sm mb-10 opacity-80 px-4">
          新大阪（きさらぎ）に到着しました。<br>巡礼報酬を解禁してください。
        </p>
        <button onclick="unlockReward()" class="btn-horror px-10 py-4 text-xs font-bold">
          報酬を解禁 (UNLOCK)
        </button>
      </div>

      <!-- UI: REWARD & REDIRECT -->
      <div id="ui-reward" class="hidden text-center scale-90 md:scale-100">
        <h2 class="text-2xl md:text-4xl font-bold mb-4 glitch">巡礼完了</h2>
        <div class="bg-white p-2 md:p-4 inline-block mb-4">
            <img id="qr-img" src="" class="w-32 h-32 md:w-44 md:h-44" alt="QR">
        </div>
        <p class="text-[10px] mb-6 text-red-400 max-w-xs mx-auto">
            クーポンと御守を発行しました。<br>ボタンを押して公式サイトで保存してください。
        </p>
        <button onclick="handleRedirect()" class="btn-horror px-8 md:px-12 py-3 md:py-4 text-xs font-bold bg-red-600 text-black">
          公式サイトへ (GO TO SITE)
        </button>
      </div>

    </div>
  </section>

  <!-- Telemetry -->
  <aside class="order-3 lg:order-3 lg:col-span-3 flex flex-col gap-3">
    <div class="terminal-border p-3 md:p-4 flex flex-row lg:flex-col justify-between items-center lg:items-start lg:h-1/2">
      <div>
        <h2 class="text-[10px] md:text-[11px] mb-1 text-red-400 font-bold border-b border-red-900">TELEMETRY</h2>
        <div class="text-2xl md:text-4xl font-bold italic" id="speed">0 <span class="text-[10px]">km/h</span></div>
      </div>
      <div class="text-[8px] md:text-[9px] opacity-40 text-right lg:text-left">
        <p>LAT: <span id="lat">---</span></p>
        <p>LNG: <span id="lng">---</span></p>
      </div>
    </div>
    <div class="terminal-border p-3 flex-grow overflow-hidden hidden lg:block">
        <h2 class="text-[11px] mb-2 text-red-400 font-bold border-b border-red-900 pb-1">LOG</h2>
        <div id="log" class="text-[8px] space-y-1 opacity-40 leading-tight">
          <p>> Initializing...</p>
        </div>
    </div>
  </aside>
</main>

<script>
const journeyMap = [
  { id: 'st-tokyo', name: '東京', msg: '東京を発車しました。', log: 'Departure: Tokyo' },
  { id: 'st-atami', name: '熱海', msg: 'まもなく熱海。トンネルが長く続きます...', log: 'Tunnel Environment detected' },
  { id: 'st-shizuoka', name: '静岡', msg: '富士山が見えます。振り返らないで。', log: 'Scanning Mt.Fuji Area' },
  { id: 'st-seki', name: '関ヶ原', msg: '警告：関ヶ原。境界線が揺らいでいます。', log: 'BOUNDARY_INTERFERENCE', scare: true },
  { id: 'st-kyoto', name: '京都', msg: '次は京都。そこには誰がいますか？', log: 'Approaching Kyoto' },
  { id: 'st-osaka', name: '新大阪', msg: '終点、新大阪。現実へ戻る準備を。', log: 'Arriving at Destination' }
];

let audioCtx, drone, gainNode;
let currentSpeed = 0;
let isJourneyStarted = false;
let isArriving = false; // 減速フラグ

function addLog(m) {
  const l = document.getElementById('log');
  if(!l) return;
  const p = document.createElement('p');
  p.innerText = `> ${m}`;
  l.prepend(p);
}

function startJourney() {
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  drone = audioCtx.createOscillator();
  gainNode = audioCtx.createGain();
  drone.type = 'sine';
  drone.frequency.setValueAtTime(45, audioCtx.currentTime);
  gainNode.gain.setValueAtTime(0.06, audioCtx.currentTime);
  drone.connect(gainNode);
  gainNode.connect(audioCtx.destination);
  drone.start();

  document.getElementById('ui-start').classList.add('hidden');
  document.getElementById('ui-ar').classList.remove('hidden');
  
  isJourneyStarted = true;
  addLog("System: Shinkansen Motor Initializing...");
  
  runLogic();
}

function runLogic() {
  let step = 0;
  const timer = setInterval(() => {
    if(step < journeyMap.length) {
      const data = journeyMap[step];
      const ann = document.getElementById('announcement');
      ann.innerText = data.msg;
      
      // 最後の駅「新大阪」になったら減速開始
      if (data.id === 'st-osaka') {
        isArriving = true;
        addLog("System: Braking Protocol Activated.");
      }

      const st = document.getElementById(data.id);
      st.classList.replace('opacity-30', 'text-white');
      st.classList.add('font-bold');
      addLog(data.log);

      if(data.scare) setTimeout(triggerScare, 1200);
      step++;
    } else {
      // 这里的逻辑搬迁到速度检测中，当速度为0时显示下一阶段
      clearInterval(timer);
    }
  }, 4500);
}

function triggerScare() {
  const overlay = document.getElementById('scare-overlay');
  overlay.style.display = 'flex';
  if(audioCtx) {
    const osc = audioCtx.createOscillator();
    osc.type = 'sawtooth';
    osc.frequency.setValueAtTime(800, audioCtx.currentTime);
    osc.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + 0.3);
  }
  setTimeout(() => overlay.style.display = 'none', 300);
}

// 最终显示到着UI
function finishJourney() {
  document.getElementById('ui-ar').classList.add('hidden');
  document.getElementById('ui-arrival').classList.remove('hidden');
  addLog("System: Full Stop. Doors opening soon.");
}

function unlockReward() {
  document.getElementById('main-viewport').classList.add('flash-white');
  setTimeout(() => document.getElementById('main-viewport').classList.remove('flash-white'), 500);
  document.getElementById('ui-arrival').classList.add('hidden');
  document.getElementById('ui-reward').classList.remove('hidden');
  
  const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=REWARD_TOKEN_2026_KSRG&color=990000`;
  document.getElementById('qr-img').src = qrUrl;
  
  if(gainNode) gainNode.gain.rampToValueAtTime(0, audioCtx.currentTime + 2);
}

function handleRedirect() {
  window.location.href = "https://www.westjr.co.jp/global/en/shinkansen/";
}

// 时间与速度逻辑 (加减速核心)
setInterval(() => {
  document.getElementById('clock').innerText = new Date().toLocaleTimeString('ja-JP', {hour12: false});
  
  if(isJourneyStarted) {
    const speedEl = document.getElementById('speed');
    
    if (isArriving) {
      // --- 減速フェーズ ---
      if (currentSpeed > 0) {
        // 速度を下げる (滑らかな減速曲線)
        currentSpeed -= (currentSpeed / 20) + 0.5; 
        if (currentSpeed <= 0) {
          currentSpeed = 0;
          finishJourney(); // 速度が0になったら到着画面へ
        }
      }
      document.getElementById('ar-status-text').innerText = "STOPPING...";
    } else {
      // --- 加速・巡航フェーズ ---
      if (currentSpeed < 280) {
        let acceleration = (300 - currentSpeed) / 25;
        currentSpeed += acceleration + (Math.random() * 2);
        if (currentSpeed > 280) currentSpeed = 280;
      } else {
        currentSpeed = 280 + (Math.random() * 10);
      }
    }
    
    speedEl.innerHTML = `${Math.floor(currentSpeed)} <span class="text-[10px]">km/h</span>`;
    
    // 位置情報の更新 (速度に比例してわずかに動かす)
    if (currentSpeed > 0) {
      document.getElementById('lat').innerText = (34.7 + (currentSpeed/10000)).toFixed(4);
      document.getElementById('lng').innerText = (135.2 + (currentSpeed/8000)).toFixed(4);
    }
  }
}, 100);

</script>
</body>
</html>
